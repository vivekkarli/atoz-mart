server:
   port: 8072

spring:
   application:
      name: atozmart-gatewayserver
   config:
      import: 'optional:configserver:'
   security:
      oauth2:
         resourceserver:
            jwt:
               jwk-set-uri: http://localhost:8073/realms/master/protocol/openid-connect/certs
   cloud:
      gateway:
         server:
            webflux:
               httpclient:
                  connect-timeout: 1000
                  response-timeout: 5s
               discovery:
                  locator:
                     enabled: false # disable default routes
                     lower-case-service-id: true
               routes:
               -  id: authserver-path-rewrite
                  uri: lb://ATOZMART-AUTHSERVER
                  predicates:
                  - Path=/atozmart/authserver/**
                  filters:
                  -  name: RewritePath
                     args:
                        regexp: atozmart/authserver/(?<segment>.*)
                        replacement: /${segment}
                  -  name: CircuitBreaker
                     args:
                        name: authserver
                        fallbackUri: forward:/fallback/authserver

               -  id: catalog-path-rewrite
                  uri: lb://CATALOG-SERVICE
                  predicates:
                  - Path=/atozmart/catalog/**
                  filters:
                  -  name: RewritePath
                     args:
                        regexp: atozmart/catalog/(?<segment>.*)
                        replacement: /${segment}
                  -  name: CircuitBreaker
                     args:
                        name: catalog-service
                        fallbackUri: forward:/fallback/catalog-service

               -  id: cart-path-rewrite
                  uri: lb://CART-SERVICE
                  predicates:
                  - Path=/atozmart/cart/**
                  filters:
                  -  name: RewritePath
                     args:
                        regexp: atozmart/cart/(?<segment>.*)
                        replacement: /${segment}
                  -  name: CircuitBreaker
                     args:
                        name: cart-service
                        fallbackUri: forward:/fallback/cart-service

               -  id: wishlist-path-rewrite
                  uri: lb://WISHLIST-SERVICE
                  predicates:
                  - Path=/atozmart/wishlist/**
                  filters:
                  -  name: RewritePath
                     args:
                        regexp: atozmart/wishlist/(?<segment>.*)
                        replacement: /${segment}
                  -  name: CircuitBreaker
                     args:
                        name: wishlist-service
                        fallbackUri: forward:/fallback/wishlist-service

               -  id: order-path-rewrite
                  uri: lb://ORDER-SERVICE
                  predicates:
                  - Path=/atozmart/order/**
                  filters:
                  -  name: RewritePath
                     args:
                        regexp: atozmart/order/(?<segment>.*)
                        replacement: /${segment}
                  -  name: CircuitBreaker
                     args:
                        name: order-service
                        fallbackUri: forward:/fallback/order-service

               -  id: profile-path-rewrite
                  uri: lb://PROFILE-SERVICE
                  predicates:
                  - Path=/atozmart/profile/**
                  filters:
                  -  name: RewritePath
                     args:
                        regexp: atozmart/profile/(?<segment>.*)
                        replacement: /${segment}
                  -  name: CircuitBreaker
                     args:
                        name: profile-service
                        fallbackUri: forward:/fallback/profile-service

   main:
      allow-bean-definition-overriding: true

resilience4j:
   timelimiter:
      instances:
         authserver:
            timeoutDuration: 2s
   circuitbreaker:
      configs:
         default:
            slidingWindowSize: 4
            slidingWindowType: COUNT_BASED
            failureRateThreshold: 50 # 50%
            waitDurationInOpenState: 10000 #10s
            permittedNumberOfCallsInHalfOpenState: 3
            registerHealthIndicator: true
      instances:
         authserver:
            slidingWindowSize: 8
         order-service:
            slidingWindowSize: 6
         catalog-service:
            slidingWindowSize: 6
         wishlist-service:
            slidingWindowSize: 6
         profile-service:
            slidingWindowSize: 6
         cart-service:
            slidingWindowSize: 6
            
eureka:
   instance:
      prefer-ip-address: true
   client:
      fetch-registry: true
      register-with-eureka: true
      serviceUrl:
         defaultZone: http://localhost:8761/eureka

management:
   endpoints:
      web:
         exposure:
            include: '*'
   endpoint:
      gateway:
         access: unrestricted
      shutdown:
         access: unrestricted
      health:
         probes:
            enabled: true
   health:
      readiness-state:
         enabled: true
      liveness-state:
         enabled: true
   info:
      env:
         enabled: true
   metrics:
      tags:
         application: ${spring.application.name}

# info properties to see info in eureka dashboard
info:
   app:
      name: atozmart-gatewayserver
      description: AtoZ mart gateway server
      version: 1.0.0
logging:
   level:
      com.netflix.discovery.DiscoveryClient: OFF
      com.atozmart.gatewayserver: DEBUG

atozmart:
   auth:
      authorize-endpoint: http://localhost:8074/admin/authorize
      issuer: atozmart-authserver
   admin:
      username: atozmart_gatewayserver